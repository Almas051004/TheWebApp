{% extends 'base.html.twig' %}

{% block title %}Главная{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="card">
        <div class="card-body p-5">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <h1 class="h3 fw-bold mb-0">Пользователи</h1>
                <a href="{{ path('app_sign_out') }}" class="btn btn-outline-secondary btn-sm">Выйти</a>
            </div>

    <form method="post" action="{{ path('app_dashboard_action') }}" id="userForm">
            <div class="d-flex align-items-center gap-2 mb-3">
            <button type="submit" name="action" value="block" class="bi bi-lock btn btn-outline-warning btn-sm"> Заблокировать</button>
            <button type="submit" name="action" value="unblock" class="bi bi-unlock btn btn-outline-success btn-sm"> Разблокировать</button>
            <button type="submit" name="action" value="delete" class="bi bi-trash btn btn-outline-danger btn-sm"> Удалить</button>

            <div class="ms-auto position-relative">
                <input type="text" class="form-control ps-5 search-input" placeholder="Поиск" id="filterInput">
                <i class="bi bi-search position-absolute top-50 start-3 translate-middle-y text-muted"></i>
            </div>
        </div>

        <div class="bg-white rounded shadow-sm table-responsive table-responsive--stacked">
            <table class="table table-borderless mb-0">
                <thead class="border-bottom">
                    <tr>
                        <th width="50">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                        </th>
                        <th class="fw-semibold">Имя</th>
                        <th class="fw-semibold">Email</th>
                        <th class="fw-semibold">Статус</th>
                    </tr>
                </thead>
                <tbody>
                {% for user in users %}
                    <tr class="border-bottom">
                        <td data-label="Выбрать">
                            <input class="form-check-input" type="checkbox" name="selected[]" value="{{ user.id }}">
                        </td>
                        <td class="text-muted" data-label="Имя">{{ user.name|default('-') }}</td>
                        <td data-label="Email">
                            <a href="mailto:{{ user.email }}" class="text-primary text-decoration-underline">
                                {{ user.email }}
                            </a>
                        </td>
                        <td data-label="Статус">
                            <span class="{% if user.status == 'Заблокирован' %}text-danger{% elseif user.status == 'Не подтверждено' %}text-secondary{% else %}text-success{% endif %} fw-medium">
                                {{ user.status }}
                            </span>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="4" class="text-center py-4 text-muted">Нет пользователей</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<script>
    document.getElementById('selectAll')?.addEventListener('click', e => {
        document.querySelectorAll('input[name="selected[]"]').forEach(cb => cb.checked = e.target.checked);
    });

    document.querySelectorAll('#userForm button[type="submit"]').forEach(button => {
        button.addEventListener('click', function(e) {
            const checked = document.querySelectorAll('input[name="selected[]"]:checked').length;
            if (checked === 0) {
                e.preventDefault();
                window.notifyError && window.notifyError('Выберите хотя бы одного пользователя!');
                return false;
            }

            if (this.value === 'delete') {
                e.preventDefault();
                const actionValue = this.value;
                window.showConfirm && window.showConfirm('Удалить выбранных пользователей?', function(){
                    const form = document.getElementById('userForm');
                    let hidden = form.querySelector('input[type="hidden"][name="action"]');
                    if (!hidden) {
                        hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = 'action';
                        form.appendChild(hidden);
                    }
                    hidden.value = actionValue;
                    form.submit();
                });
                return false;
            }
        });
    });

    document.getElementById('filterInput')?.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('#userForm tbody tr').forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });

    const tbody = document.querySelector('#userForm tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.forEach((row, i) => row.dataset.origOrder = i);

    document.querySelectorAll('#userForm thead th').forEach((th, index) => {
        if (index === 0) return;

        th.style.cursor = 'pointer';

        let sortState = 0;

        th.addEventListener('click', () => {
            document.querySelectorAll('#userForm thead th').forEach(h => 
                h.textContent = h.textContent.replace(/ [↑↓]$/, '')
            );

            sortState = (sortState + 1) % 3;

            let sortedRows;

            if (sortState === 0) {
                sortedRows = rows.slice().sort((a, b) => 
                    a.dataset.origOrder - b.dataset.origOrder
                );
                th.textContent += '';
            } else {
                sortedRows = rows.slice().sort((a, b) => {
                    let aText = a.children[index].textContent.trim();
                    let bText = b.children[index].textContent.trim();

                    if (index === 3) {
                        const order = { 'Заблокирован': 1, 'Не подтверждено': 2, 'Активен': 3 };
                        aText = order[aText] ?? 0;
                        bText = order[bText] ?? 0;
                    } else {
                        const cmp = aText.localeCompare(bText, undefined, {sensitivity: 'base'});
                        return sortState === 1 ? cmp : -cmp;
                    }

                    return sortState === 1 ? (aText - bText) : (bText - aText);
                });

                th.textContent += sortState === 1 ? ' ↑' : ' ↓';
            }

            sortedRows.forEach(row => tbody.appendChild(row));
        });
    });
</script>
{% endblock %}